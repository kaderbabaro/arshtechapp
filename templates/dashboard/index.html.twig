{% extends 'base.html.twig' %}
{% set mois = {
    1: 'janvier',
    2: 'février',
    3: 'mars',
    4: 'avril',
    5: 'mai',
    6: 'juin',
    7: 'juillet',
    8: 'août',
    9: 'septembre',
    10: 'octobre',
    11: 'novembre',
    12: 'décembre'
} %}

{% set moisActuel = "now"|date("n") %}
{% set trimestreActuel = moisActuel <= 3
    ? 1
    : (moisActuel <= 6
        ? 2
        : (moisActuel <= 9
            ? 3
            : 4)) %}

{% set actifTrimestre = actifsTrim[trimestreActuel] ?? 0 %}
{% set passifTrimestre = passifsTrim[trimestreActuel] ?? 0 %}
{% set totalTrimestre = actifTrimestre + passifTrimestre %}


{% block title %}Tableau de bord{% endblock %}

{% block body %}

<style>
    <link href="{{ asset('sbadmin/vendor/fontawesome-free/css/all.min.css') }}" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link href="{{ asset('sbadmin/css/sb-admin-2.min.css') }}" rel="stylesheet">
    <link rel="icon" type="image/png" href="images\logo.png">

    .example-wrapper { margin: 1em auto; max-width: 800px; width: 95%; font: 18px/1.5 sans-serif; }
    .example-wrapper code { background: #F5F5F5; padding: 2px 6px; }

    .container {
      display: flex;
      justify-content: space-around;
      padding: 50px 20px;
      gap: 40px;
      flex-wrap: wrap;
    }

    .subscribe-box, .message-box {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex: 1 1 350px;
    }

    .icon-circle {
      background-color: #00c0ef;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      margin: 0 auto 15px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .icon-circle img {
      width: 30px;
      height: 30px;
    }

    h2 {
      font-size: 16px;
      text-align: center;
      margin-bottom: 20px;
    }

    .subscribe-form {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .subscribe-form button {
      background-color: #00a7d0;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    .subscribe-form button:hover {
      background-color: #008bb2;
    }

    .message-box h3 {
      margin-bottom: 10px;
      font-size: 18px;
      text-align: center;
    }

    ul.message-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: auto;
      overflow-y: auto;
    }

    ul.message-list li {
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    ul.message-list li:last-child {
      border-bottom: none;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>


    <style>
    .chart-container {
        margin: 40px auto;
        padding: 20px;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        max-width: fit-content;
    }

    .chart-container h5 {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        text-align: center;
        position: relative;
    }

    .chart-container h5::after {
        content: '';
        display: block;
        width: 60px;
        height: 3px;
        background: #007bff;
        margin: 8px auto 0 auto;
        border-radius: 2px;
    }

    #transactionChart {
        width: 100% !important;
        height: auto !important;
    }

    @media (max-width: 768px) {
        .chart-container {
            padding: 15px;
        }
    }

</style>

<body id="page-top">

  <!-- Page Wrapper -->
  <div id="wrapper">
    {% include "SideBar.html.twig" %}

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

      <!-- Main Content -->
      <div id="content">
        {% include "TopBar.html.twig" %}

        <!-- Begin Page Content -->
        <div class="container-fluid">

          <!-- Page Heading -->
          <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Tableau de bord</h1>
            <a href="#" id="generate-report-btn" class="d-none d-sm-inline-block btn btn-sm btn-warning shadow-sm">
              <i class="fas fa-download fa-sm text-white-50"></i> Générer un rapport
            </a>
          </div>

          <!-- Content Row -->
          <div class="row">
            <!-- Revenus Mensuel -->
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                  <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                      <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Revenus Mensuel</div>
                      <div class="h5 mb-0 text-danger-800">
                        {% for ligne in actifsParMois %}
                          <div class="font-weight-bold">
                            {{ mois[ligne.mois]|capitalize }} :
                          </div>
                          {{ ligne.total }} Frcfa
                        {% else %}
                          <h5>Aucune donnée</h5>
                        {% endfor %}
                      </div>
                    </div>
                    <div class="col-auto">
                      <i class="fas fa-calendar fa-2x text-danger-300"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Revenus Trimestriel -->
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                  <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                      <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Revenus Trimestriel</div>
                      <div class="h5 mb-0 font-weight-bold text-gray-800">
                        {% if revenusTrimestriels is not empty %}
                          Trimestre {{ trimestreActuel }}:
                        {% else %}
                          <h5>Aucune donnée</h5>
                        {% endif %}
                        <h5>{{ actifTrimestre|number_format(0, '.', ' ') }} Fcfa</h5>
                      </div>
                    </div>
                    <div class="col-auto">
                      <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tâches -->
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                  <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                      <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Tâches</div>
                      <div class="row no-gutters align-items-center">
                        <div class="col-auto">
                          <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{ tauxTaches }}%</div>
                        </div>
                        <div class="col">
                          <div class="progress progress-sm mr-2">
                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ tauxTaches }}%"
                              aria-valuenow="{{ tauxTaches }}" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-auto">
                      <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Nombre de partenaires -->
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                  <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                      <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Nombre de partenaires</div>
                      <div class="h5 mb-0 font-weight-bold text-gray-800">{{ nombrePartenaires }}</div>
                    </div>
                    <div class="col-auto">
                      <i class="fas fa-comments fa-2x text-gray-300"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Graphique des transactions -->
          <div class="row">
            <div class="col-md-12">
              <h5 class="text-primary">Statistiques des fonds de transaction</h5>
              <canvas id="transactionChart" style="max-height: fit-content;"></canvas>
            </div>
          </div>

          <!-- Section Notes -->
          <div class="row">
            <!-- Formulaire -->
            <div class="col-md-3">
              <div class="subscribe-box bg-white shadow p-4 rounded text-center h-100">
                <div class="icon-circle mb-3">
                  <img src="https://img.icons8.com/ios-filled/50/ffffff/send-mass-email.png" alt="email icon" />
                </div>
                <h4 class="mb-3 text-primary">Ajouter votre note</h4>
                <form class="subscribe-form" action="{{ path('dashboard_note_add') }}" method="POST">
                  <input type="text" class="form-control mb-3" placeholder="Écrivez votre message" name="message" required>
                  <button type="submit" class="btn btn-success w-100">Ajouter</button>
                </form>
              </div>
            </div>

            <!-- Messages -->
            <div class="col-md-9">
              <div class="message-box shadow p-4 rounded bg-light">
                <h4 class="mb-4 text-primary">Messages envoyés</h4>
                <div class="table-responsive">
                  <table class="table table-hover align-middle text-center">
                    <thead class="table-dark">
                      <tr>
                        <th>Utilisateur</th>
                        <th>Message</th>
                        <th>Date</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for note in notes %}
                        <tr>
                          <td>{{ app.user.NomUtilisateur is defined and app.user.NomUtilisateur ? app.user.NomUtilisateur : app.user.username }}</td>
                          <td>{{ note.Message }}</td>
                          <td>{{ note.CreatedAt ? note.CreatedAt|date('d/m/Y H:i') : '' }}</td>
                          <td>
                            
                            <form method="post" action="{{ path('app_note_delete', {'id': note.id}) }}" style="display:inline-block;" onsubmit="return confirm('Voulez-vous vraiment supprimer cette note ?');">
                              <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ note.id) }}">
                              <button class="btn btn-sm btn-danger">Supprimer</button>
                            </form>
                          </td>
                        </tr>
                      {% else %}
                        <tr>
                          <td colspan="4">Aucune note pour le moment.</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>

        <script>
  document.getElementById('generate-report-btn').addEventListener('click', function (e) {
    e.preventDefault();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Contenu du rapport
    doc.setFontSize(16);
    doc.text("Rapport de performances - ARSHTECH", 20, 20);
    doc.setFontSize(12);
    doc.text("Date : " + new Date().toLocaleDateString(), 20, 30);
    doc.text("Revenu mensuel (Mai) : 125 000 Fcfa", 20, 40);
    doc.text("Revenu trimestriel (T2) : 125 000 Fcfa", 20, 50);
    doc.text("Tâches accomplies : 33.33%", 20, 60);
    doc.text("Nombre de partenaires : 0", 20, 70);

    // Générer et télécharger le PDF
    doc.save("rapport-arschtech.pdf");
  });
</script>


        <!-- Script du graphique -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
          const ctx = document.getElementById('transactionChart').getContext('2d');
          const transactionChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: {{ labels|json_encode|raw }},
              datasets: [
                {
                  label: 'Passif',
                  data: {{ dataPassifs|json_encode|raw }},
                  borderColor: 'rgba(255, 0, 0, 0.8)',
                  backgroundColor: 'rgba(255, 0, 0, 0.15)',
                  fill: true,
                  tension: 0.3
                },
                {
                  label: 'Actif',
                  data: {{ dataActifs|json_encode|raw }},
                  borderColor: 'rgba(0, 0, 255, 0.8)',
                  backgroundColor: 'rgba(0, 0, 255, 0.15)',
                  fill: true,
                  tension: 0.3
                }
              ]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'top'
                },
                tooltip: {
                  mode: 'index',
                  intersect: false
                }
              },
              interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Montant (Frcfa)'
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: 'Mois / Année'
                  }
                }
              }
            }
          });
        </script>

      </div>
    </div>
  </div>
</body>
{% endblock %}
